"use strict";angular.module("mentio",[]).directive("mentio",["mentioUtil","$compile","$log","$document","$timeout",function(e,t,n,r,i){return{restrict:"A",scope:{macros:"=mentioMacros",search:"&mentioSearch",select:"&mentioSelect",items:"=mentioItems",typedTerm:"=mentioTypedTerm",altId:"=mentioId",requireLeadingSpace:"=mentioRequireLeadingSpace",ngModel:"="},controller:["$scope","$timeout","$attrs",function(t,n,i){t.query=function(e,n){var r=t.triggerCharMap[e];r.showMenu(),r.search({term:n.trim()}),r.typedTerm=n.trim()},t.defaultSearch=function(e){var n=[];angular.forEach(t.items,function(t){t.label.toUpperCase().indexOf(e.term.toUpperCase())>=0&&n.push(t)}),t.localItems=n},t.bridgeSearch=function(e){var n=i.mentioSearch?t.search:t.defaultSearch;n({term:e})},t.defaultSelect=function(e){return t.defaultTriggerChar+e.item.label},t.bridgeSelect=function(e){var n=i.mentioSelect?t.select:t.defaultSelect;return n({item:e})},t.setTriggerText=function(e){t.syncTriggerText&&(t.typedTerm=e.trim())},t.replaceText=function(r){if(t.hideAll(),e.replaceTriggerText(t.targetElement,t.targetElementPath,t.targetElementSelectedOffset,t.triggerCharSet,r,t.requireLeadingSpace),t.setTriggerText(""),angular.element(t.targetElement).triggerHandler("change"),t.isContentEditable()){t.contentEditableMenuPasted=!0;var i=n(function(){t.contentEditableMenuPasted=!1},100);t.$on("$destroy",function(){n.cancel(i)})}},t.hideAll=function(){for(var e in t.triggerCharMap)t.triggerCharMap.hasOwnProperty(e)&&t.triggerCharMap[e].hideMenu()},t.getActiveMenuScope=function(){for(var e in t.triggerCharMap)if(t.triggerCharMap.hasOwnProperty(e)&&t.triggerCharMap[e].visible)return t.triggerCharMap[e];return null},t.selectActive=function(){for(var e in t.triggerCharMap)t.triggerCharMap.hasOwnProperty(e)&&t.triggerCharMap[e].visible&&t.triggerCharMap[e].selectActive()},t.isActive=function(){for(var e in t.triggerCharMap)if(t.triggerCharMap.hasOwnProperty(e)&&t.triggerCharMap[e].visible)return!0;return!1},t.isContentEditable=function(){return"INPUT"!==t.targetElement.nodeName&&"TEXTAREA"!==t.targetElement.nodeName},t.replaceMacro=function(r,i){i?e.replaceMacroText(t.targetElement,t.targetElementPath,t.targetElementSelectedOffset,t.macros,t.macros[r]):(t.replacingMacro=!0,t.timer=n(function(){e.replaceMacroText(t.targetElement,t.targetElementPath,t.targetElementSelectedOffset,t.macros,t.macros[r]),angular.element(t.targetElement).triggerHandler("change"),t.replacingMacro=!1},300),t.$on("$destroy",function(){n.cancel(t.timer)}))},t.addMenu=function(e){e.parentScope&&t.triggerCharMap.hasOwnProperty(e.triggerChar)||(t.triggerCharMap[e.triggerChar]=e,void 0===t.triggerCharSet&&(t.triggerCharSet=[]),t.triggerCharSet.push(e.triggerChar),e.setParent(t))},t.$on("menuCreated",function(e,n){(void 0!==i.id||void 0!==i.mentioId)&&(i.id===n.targetElement||void 0!==i.mentioId&&t.altId===n.targetElement)&&t.addMenu(n.scope)}),r.on("click",function(){t.isActive()&&t.$apply(function(){t.hideAll()})}),r.on("keydown keypress paste",function(e){var n=t.getActiveMenuScope();n&&((9===e.which||13===e.which)&&(e.preventDefault(),n.selectActive()),27===e.which&&(e.preventDefault(),n.$apply(function(){n.hideMenu()})),40===e.which&&(e.preventDefault(),n.$apply(function(){n.activateNextItem()})),38===e.which&&(e.preventDefault(),n.$apply(function(){n.activatePreviousItem()})),(37===e.which||39===e.which)&&e.preventDefault())})}],link:function(r,o,a){if(r.triggerCharMap={},r.targetElement=o,a.$set("autocomplete","off"),a.mentioItems){r.localItems=[],r.parentScope=r;var c=a.mentioSearch?' mentio-items="items"':' mentio-items="localItems"';r.defaultTriggerChar=a.mentioTriggerChar?r.$eval(a.mentioTriggerChar):"@";var l='<mentio-menu mentio-search="bridgeSearch(term)" mentio-select="bridgeSelect(item)"'+c;a.mentioTemplateUrl&&(l=l+' mentio-template-url="'+a.mentioTemplateUrl+'"'),l=l+" mentio-trigger-char=\"'"+r.defaultTriggerChar+'\'" mentio-parent-scope="parentScope"/>';var s=t(l),m=s(r);o.parent().append(m),r.$on("$destroy",function(){m.remove()})}a.mentioTypedTerm&&(r.syncTriggerText=!0),r.$watch("ngModel",function(t){if(void 0!==t){if(void 0===r.triggerCharSet)return void n.error("Error, no mentio-items attribute was provided, and no separate mentio-menus were specified.  Nothing to do.");if(r.contentEditableMenuPasted)return void(r.contentEditableMenuPasted=!1);r.replacingMacro&&(i.cancel(r.timer),r.replacingMacro=!1);var o=r.isActive(),a=r.isContentEditable(),c=e.getTriggerInfo(r.triggerCharSet,r.requireLeadingSpace,o);if(void 0!==c&&(!o||o&&(a&&c.mentionTriggerChar===r.currentMentionTriggerChar||!a&&c.mentionPosition===r.currentMentionPosition)))c.mentionSelectedElement&&(r.targetElement=c.mentionSelectedElement,r.targetElementPath=c.mentionSelectedPath,r.targetElementSelectedOffset=c.mentionSelectedOffset),r.setTriggerText(c.mentionText),r.currentMentionPosition=c.mentionPosition,r.currentMentionTriggerChar=c.mentionTriggerChar,r.query(c.mentionTriggerChar,c.mentionText);else{r.setTriggerText(""),r.hideAll();var l=e.getMacroMatch(r.macros);void 0!==l&&(r.targetElement=l.macroSelectedElement,r.targetElementPath=l.macroSelectedPath,r.targetElementSelectedOffset=l.macroSelectedOffset,r.replaceMacro(l.macroText,l.macroHasTrailingSpace))}}})}}}]).directive("mentioMenu",["mentioUtil","$rootScope","$log","$window","$document",function(e,t,n,r,i){return{restrict:"E",scope:{search:"&mentioSearch",select:"&mentioSelect",items:"=mentioItems",triggerChar:"=mentioTriggerChar",forElem:"=mentioFor",parentScope:"=mentioParentScope"},templateUrl:function(e,t){return void 0!==t.mentioTemplateUrl?t.mentioTemplateUrl:"mentio-menu.tpl.html"},controller:["$scope",function(e){e.visible=!1,this.activate=e.activate=function(t){e.activeItem=t},this.isActive=e.isActive=function(t){return e.activeItem===t},this.selectItem=e.selectItem=function(t){var n=e.select({item:t});"function"==typeof n.then?n.then(e.parentMentio.replaceText):e.parentMentio.replaceText(n)},e.activateNextItem=function(){var t=e.items.indexOf(e.activeItem);this.activate(e.items[(t+1)%e.items.length])},e.activatePreviousItem=function(){var t=e.items.indexOf(e.activeItem);this.activate(e.items[0===t?e.items.length-1:t-1])},e.selectActive=function(){e.selectItem(e.activeItem)},e.isVisible=function(){return e.visible},e.showMenu=function(){e.visible||(e.requestVisiblePendingSearch=!0)},e.setParent=function(t){e.parentMentio=t,e.targetElement=t.targetElement}}],link:function(o,a){if(a[0].parentNode.removeChild(a[0]),i[0].body.appendChild(a[0]),o.menuElement=a,o.parentScope)o.parentScope.addMenu(o);else{if(!o.forElem)return void n.error("mentio-menu requires a target element in tbe mentio-for attribute");if(!o.triggerChar)return void n.error("mentio-menu requires a trigger char");t.$broadcast("menuCreated",{targetElement:o.forElem,scope:o})}angular.element(r).bind("resize",function(){if(o.isVisible()){var t=[];t.push(o.triggerChar),e.popUnderMention(t,a,o.requireLeadingSpace)}}),o.$watch("items",function(e){e&&e.length>0?(o.activate(e[0]),!o.visible&&o.requestVisiblePendingSearch&&(o.visible=!0,o.requestVisiblePendingSearch=!1)):o.hideMenu()}),o.$watch("isVisible()",function(t){if(t){var n=[];n.push(o.triggerChar),e.popUnderMention(n,a,o.requireLeadingSpace)}}),o.hideMenu=function(){o.visible=!1,a.css("display","none")}}}}]).directive("mentioMenuItem",function(){return{restrict:"A",scope:{item:"=mentioMenuItem"},require:"^mentioMenu",link:function(e,t,n,r){e.$watch(function(){return r.isActive(e.item)},function(e){e?t.addClass("active"):t.removeClass("active")}),t.bind("mouseenter",function(){e.$apply(function(){r.activate(e.item)})}),t.bind("click",function(t){t.preventDefault(),r.selectItem(e.item)})}}}).filter("unsafe",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}]).filter("mentioHighlight",function(){function e(e){return e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}return function(t,n,r){if(n){var i=r?'<span class="'+r+'">$&</span>':"<strong>$&</strong>";return(""+t).replace(new RegExp(e(n),"gi"),i)}return t}}),angular.module("mentio").factory("mentioUtil",["$window","$location","$anchorScroll","$timeout",function(e,t,n,r){function i(e,t,n){var i,c=h(e,n,!1);void 0!==c?(i=a()?S(document.activeElement,c.mentionPosition):v(c.mentionPosition),t.css({top:i.top+"px",left:i.left+"px",position:"absolute",zIndex:100,display:"block"}),r(function(){o(t)},0)):t.css({display:"none"})}function o(t){for(var n,r=20,i=100,o=t[0];void 0===n||0===n.height;)if(n=o.getBoundingClientRect(),0===n.height&&(o=o.childNodes[0],void 0===o||!o.getBoundingClientRect))return;var a=n.top,c=a+n.height;if(0>a)e.scrollTo(0,e.pageYOffset+n.top-r);else if(c>e.innerHeight){var l=e.pageYOffset+n.top-r;l-e.pageYOffset>i&&(l=e.pageYOffset+i);var s=e.pageYOffset-(e.innerHeight-c);s>l&&(s=l),e.scrollTo(0,s)}}function a(){var e=document.activeElement;if(null!==e){var t=e.nodeName,n=e.getAttribute("type");return"INPUT"===t&&"text"===n||"TEXTAREA"===t}return!1}function c(e,t,n){var r,i=e;if(t)for(var o=0;o<t.length;o++){if(i=i.childNodes[t[o]],void 0===i)return;for(;i.length<n;)n-=i.length,i=i.nextSibling}var a=window.getSelection();r=document.createRange(),r.setStart(i,n),r.setEnd(i,n),r.collapse(!0);try{a.removeAllRanges()}catch(c){}a.addRange(r),e.focus()}function l(e,t,n){var r,i;i=window.getSelection(),r=document.createRange(),r.setStart(i.anchorNode,t),r.setEnd(i.anchorNode,n),r.deleteContents();var o=document.createElement("div");o.innerHTML=e;for(var a,c,l=document.createDocumentFragment();a=o.firstChild;)c=l.appendChild(a);r.insertNode(l),c&&(r=r.cloneRange(),r.setStartAfter(c),r.collapse(!0),i.removeAllRanges(),i.addRange(r))}function s(e,t,n){var r=e.nodeName;"INPUT"===r||"TEXTAREA"===r?e!==document.activeElement&&e.focus():c(e,t,n)}function m(e,t,n,r,i){s(e,t,n);var o=d(r);if(o.macroHasTrailingSpace&&(o.macroText=o.macroText+" ",i+=" "),void 0!==o){var c=document.activeElement;if(a()){var m=o.macroPosition,g=o.macroPosition+o.macroText.length;c.value=c.value.substring(0,m)+i+c.value.substring(g,c.value.length),c.selectionStart=m+i.length,c.selectionEnd=m+i.length}else l(i,o.macroPosition,o.macroPosition+o.macroText.length)}}function g(e,t,n,r,i,o){s(e,t,n);var c=h(r,o,!0);if(void 0!==c)if(a()){var m=document.activeElement;i+=" ";var g=c.mentionPosition,u=c.mentionPosition+c.mentionText.length+1;m.value=m.value.substring(0,g)+i+m.value.substring(u,m.value.length),m.selectionStart=g+i.length,m.selectionEnd=g+i.length}else i+=" ",l(i,c.mentionPosition,c.mentionPosition+c.mentionText.length+1)}function u(e){if(null===e.parentNode)return 0;for(var t=0;t<e.parentNode.childNodes.length;t++){var n=e.parentNode.childNodes[t];if(n===e)return t}}function d(e){var t,n,r=[];if(a())t=document.activeElement;else{var i=f();i&&(t=i.selected,r=i.path,n=i.offset)}var o=p();if(void 0!==o&&null!==o){var c,l=!1;if(o.length>0&&(" "===o.charAt(o.length-1)||" "===o.charAt(o.length-1))&&(l=!0,o=o.substring(0,o.length-1)),angular.forEach(e,function(e,i){var a=o.toUpperCase().lastIndexOf(i.toUpperCase());if(a>=0&&i.length+a===o.length){var s=a-1;(0===a||" "===o.charAt(s)||" "===o.charAt(s))&&(c={macroPosition:a,macroText:i,macroSelectedElement:t,macroSelectedPath:r,macroSelectedOffset:n,macroHasTrailingSpace:l})}}),c)return c}}function f(){var e,t=window.getSelection(),n=t.anchorNode,r=[];if(null!=n){for(var i,o=n.contentEditable;null!==n&&"true"!==o;)i=u(n),r.push(i),n=n.parentNode,null!==n&&(o=n.contentEditable);return r.reverse(),e=t.getRangeAt(0).startOffset,{selected:n,path:r,offset:e}}}function h(e,t,n){var r,i,o;if(a())r=document.activeElement;else{var c=f();c&&(r=c.selected,i=c.path,o=c.offset)}var l=p();if(void 0!==l&&null!==l){var s,m=-1;if(e.forEach(function(e){var t=l.lastIndexOf(e);t>m&&(m=t,s=e)}),m>=0&&(0===m||!t||/[\xA0\s]/g.test(l.substring(m-1,m)))){var g=l.substring(m+1,l.length);s=l.substring(m,m+1);var u=g.substring(0,1),d=g.length>0&&(" "===u||" "===u);if(!d&&(n||!/[\xA0\s]/g.test(g)))return{mentionPosition:m,mentionText:g,mentionSelectedElement:r,mentionSelectedPath:i,mentionSelectedOffset:o,mentionTriggerChar:s}}}}function p(){var e;if(a()){var t=document.activeElement,n=t.selectionStart;e=t.value.substring(0,n)}else{var r=window.getSelection().anchorNode;if(null!=r){var i=r.textContent,o=window.getSelection().getRangeAt(0).startOffset;o>=0&&(e=i.substring(0,o))}}return e}function v(e){var t,n,r="﻿",i="sel_"+(new Date).getTime()+"_"+Math.random().toString().substr(2),o=window.getSelection(),a=o.getRangeAt(0);n=document.createRange(),n.setStart(o.anchorNode,e),n.setEnd(o.anchorNode,e),n.collapse(!1),t=document.createElement("span"),t.id=i,t.appendChild(document.createTextNode(r)),n.insertNode(t),o.removeAllRanges(),o.addRange(a);var c=t,l={left:0,top:t.offsetHeight};do l.left+=c.offsetLeft,l.top+=c.offsetTop;while(c=c.offsetParent);return t.parentNode.removeChild(t),l}function S(e,t){var n=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"],r=null!==window.mozInnerScreenX,i=document.createElement("div");i.id="input-textarea-caret-position-mirror-div",document.body.appendChild(i);var o=i.style,a=window.getComputedStyle?getComputedStyle(e):e.currentStyle;o.whiteSpace="pre-wrap","INPUT"!==e.nodeName&&(o.wordWrap="break-word"),o.position="absolute",o.visibility="hidden",n.forEach(function(e){o[e]=a[e]}),r?(o.width=parseInt(a.width)-2+"px",e.scrollHeight>parseInt(a.height)&&(o.overflowY="scroll")):o.overflow="hidden",i.textContent=e.value.substring(0,t),"INPUT"===e.nodeName&&(i.textContent=i.textContent.replace(/\s/g," "));var c=document.createElement("span");c.textContent=e.value.substring(t)||".",i.appendChild(c);var l={top:c.offsetTop+parseInt(a.borderTopWidth)+parseInt(a.fontSize),left:c.offsetLeft+parseInt(a.borderLeftWidth)},s=e;do l.left+=s.offsetLeft,l.top+=s.offsetTop;while(s=s.offsetParent);return document.body.removeChild(i),l}return{popUnderMention:i,replaceMacroText:m,replaceTriggerText:g,getMacroMatch:d,getTriggerInfo:h,selectElement:c,getTextAreaOrInputUnderlinePosition:S,getTextPrecedingCurrentSelection:p,getContentEditableSelectedPath:f,getNodePositionInParent:u,getContentEditableCaretPosition:v,pasteHtml:l,resetSelection:s,scrollIntoView:o}}]),angular.module("mentio").run(["$templateCache",function(e){e.put("mentio-menu.tpl.html",'<style>\n.scrollable-menu {\n    height: auto;\n    max-height: 300px;\n    overflow: auto;\n}\n\n.menu-highlighted {\n    font-weight: bold;\n}\n</style>\n<ul class="dropdown-menu scrollable-menu" style="display:block">\n    <li mentio-menu-item="item" ng-repeat="item in items track by $index">\n        <a class="text-primary" ng-bind-html="item.label | mentioHighlight:typedTerm:\'menu-highlighted\' | unsafe"></a>\n    </li>\n</ul>')}]);